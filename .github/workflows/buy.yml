# =============================================================================
# TOKEN ACTIVITY BOT - BUY WORKFLOW
# =============================================================================
# This workflow executes buy operations on a 30-minute schedule.
# Schedule: Every hour at :00 and :30 (e.g., 12:00, 12:30, 13:00, 13:30)
#
# SECURITY NOTES:
# - Private key is stored in GitHub Secrets (never exposed in logs)
# - All sensitive data is masked in workflow outputs
# - Workflow runs in isolated environment
# =============================================================================

name: ðŸŸ¢ Buy Token

on:
  # Scheduled execution - runs at minute 0 and 30 of every hour
  schedule:
    - cron: '0,30 * * * *'  # Every 30 minutes
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual transactions)'
        required: false
        default: false
        type: boolean
      custom_amount:
        description: 'Custom USD amount (overrides random, leave empty for random)'
        required: false
        type: string

# Prevent concurrent runs to avoid nonce conflicts
concurrency:
  group: trading-bot
  cancel-in-progress: false

env:
  NODE_ENV: production

jobs:
  buy:
    name: Execute Buy Order
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # Only run if secrets are configured
    if: ${{ vars.BOT_ENABLED != 'false' }}
    
    outputs:
      success: ${{ steps.buy.outputs.success }}
      tx_hash: ${{ steps.buy.outputs.tx_hash }}
      amount_usd: ${{ steps.buy.outputs.amount_usd }}
      tokens_received: ${{ steps.buy.outputs.tokens_received }}

    steps:
      # =========================================================================
      # SETUP
      # =========================================================================
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --production

      # =========================================================================
      # PRE-FLIGHT CHECKS
      # =========================================================================
      - name: ðŸ” Validate Secrets
        run: |
          echo "Validating required secrets..."
          
          if [ -z "${{ secrets.PRIVATE_KEY }}" ]; then
            echo "::error::PRIVATE_KEY secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.TOKEN_ADDRESS }}" ]; then
            echo "::error::TOKEN_ADDRESS secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.RPC_URL }}" ]; then
            echo "::error::RPC_URL secret is not set"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: ðŸ“Š Log Execution Context
        run: |
          echo "## Execution Context" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Trigger** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run Number** | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dry Run** | ${{ inputs.dry_run || 'false' }} |" >> $GITHUB_STEP_SUMMARY

      # =========================================================================
      # EXECUTE BUY
      # =========================================================================
      - name: ðŸ’° Execute Buy Order
        id: buy
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          TOKEN_ADDRESS: ${{ secrets.TOKEN_ADDRESS }}
          RPC_URL: ${{ secrets.RPC_URL }}
          SLIPPAGE_TOLERANCE: ${{ vars.SLIPPAGE_TOLERANCE || '5' }}
          MAX_GAS_PRICE: ${{ vars.MAX_GAS_PRICE || '50' }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
          CUSTOM_AMOUNT: ${{ inputs.custom_amount }}
        run: |
          echo "Starting buy operation..."
          npm run buy

      # =========================================================================
      # POST-EXECUTION
      # =========================================================================
      - name: ðŸ“ Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: buy-logs-${{ github.run_id }}
          path: logs/
          retention-days: 30
          if-no-files-found: ignore

      - name: ðŸ”” Notify on Failure
        if: failure()
        run: |
          echo "::error::Buy operation failed. Check the logs for details."
          echo "## âŒ Buy Failed" >> $GITHUB_STEP_SUMMARY
          echo "The buy operation encountered an error. Please check the workflow logs and artifacts for details." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # NOTIFICATION JOB (Optional - for external notifications)
  # ===========================================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: buy
    if: always() && vars.NOTIFICATIONS_ENABLED == 'true'
    
    steps:
      - name: ðŸ“§ Send Notification
        run: |
          STATUS="${{ needs.buy.result }}"
          if [ "$STATUS" == "success" ]; then
            echo "Buy completed successfully"
            # Add webhook/notification logic here if needed
          else
            echo "Buy failed or was cancelled"
            # Add failure notification logic here
          fi
