# =============================================================================
# TOKEN ACTIVITY BOT - SELL WORKFLOW
# =============================================================================
# This workflow executes sell operations on a 30-minute schedule.
# Schedule: Every hour at :15 and :45 (offset from buy by 15 minutes)
# This ensures sells happen 15 minutes after buys, giving time for the
# buy transaction to confirm.
#
# SECURITY NOTES:
# - Private key is stored in GitHub Secrets (never exposed in logs)
# - All sensitive data is masked in workflow outputs
# - Workflow runs in isolated environment
# =============================================================================

name: ðŸ”´ Sell Token

on:
  # Scheduled execution - runs at minute 15 and 45 of every hour
  # This is offset from buy (0,30) to ensure sells happen after buys
  schedule:
    - cron: '15,45 * * * *'  # 15 minutes after each buy
  
  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no actual transactions)'
        required: false
        default: false
        type: boolean
      force_sell:
        description: 'Force sell even if balance is low'
        required: false
        default: false
        type: boolean

# Prevent concurrent runs to avoid nonce conflicts
concurrency:
  group: trading-bot
  cancel-in-progress: false

env:
  NODE_ENV: production

jobs:
  sell:
    name: Execute Sell Order
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    # Only run if secrets are configured
    if: ${{ vars.BOT_ENABLED != 'false' }}
    
    outputs:
      success: ${{ steps.sell.outputs.success }}
      skipped: ${{ steps.sell.outputs.skipped }}
      tx_hash: ${{ steps.sell.outputs.tx_hash }}
      tokens_sold: ${{ steps.sell.outputs.tokens_sold }}
      eth_received: ${{ steps.sell.outputs.eth_received }}
      usd_value: ${{ steps.sell.outputs.usd_value }}

    steps:
      # =========================================================================
      # SETUP
      # =========================================================================
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install Dependencies
        run: npm ci --production

      # =========================================================================
      # PRE-FLIGHT CHECKS
      # =========================================================================
      - name: ðŸ” Validate Secrets
        run: |
          echo "Validating required secrets..."
          
          if [ -z "${{ secrets.PRIVATE_KEY }}" ]; then
            echo "::error::PRIVATE_KEY secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.TOKEN_ADDRESS }}" ]; then
            echo "::error::TOKEN_ADDRESS secret is not set"
            exit 1
          fi
          
          if [ -z "${{ secrets.RPC_URL }}" ]; then
            echo "::error::RPC_URL secret is not set"
            exit 1
          fi
          
          echo "âœ… All required secrets are configured"

      - name: ðŸ“Š Log Execution Context
        run: |
          echo "## Execution Context" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Trigger** | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run ID** | ${{ github.run_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Run Number** | ${{ github.run_number }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Timestamp** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |" >> $GITHUB_STEP_SUMMARY
          echo "| **Dry Run** | ${{ inputs.dry_run || 'false' }} |" >> $GITHUB_STEP_SUMMARY

      # =========================================================================
      # EXECUTE SELL
      # =========================================================================
      - name: ðŸ’¸ Execute Sell Order
        id: sell
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}
          TOKEN_ADDRESS: ${{ secrets.TOKEN_ADDRESS }}
          RPC_URL: ${{ secrets.RPC_URL }}
          SLIPPAGE_TOLERANCE: ${{ vars.SLIPPAGE_TOLERANCE || '5' }}
          MAX_GAS_PRICE: ${{ vars.MAX_GAS_PRICE || '50' }}
          DRY_RUN: ${{ inputs.dry_run || 'false' }}
          FORCE_SELL: ${{ inputs.force_sell || 'false' }}
        run: |
          echo "Starting sell operation..."
          npm run sell

      # =========================================================================
      # POST-EXECUTION
      # =========================================================================
      - name: ðŸ“ Upload Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sell-logs-${{ github.run_id }}
          path: logs/
          retention-days: 30
          if-no-files-found: ignore

      - name: ðŸ”” Notify on Failure
        if: failure()
        run: |
          echo "::error::Sell operation failed. Check the logs for details."
          echo "## âŒ Sell Failed" >> $GITHUB_STEP_SUMMARY
          echo "The sell operation encountered an error. Please check the workflow logs and artifacts for details." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # NOTIFICATION JOB (Optional - for external notifications)
  # ===========================================================================
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: sell
    if: always() && vars.NOTIFICATIONS_ENABLED == 'true'
    
    steps:
      - name: ðŸ“§ Send Notification
        run: |
          STATUS="${{ needs.sell.result }}"
          SKIPPED="${{ needs.sell.outputs.skipped }}"
          
          if [ "$STATUS" == "success" ]; then
            if [ "$SKIPPED" == "true" ]; then
              echo "Sell skipped - no tokens to sell"
            else
              echo "Sell completed successfully"
              echo "Tokens sold: ${{ needs.sell.outputs.tokens_sold }}"
              echo "ETH received: ${{ needs.sell.outputs.eth_received }}"
            fi
          else
            echo "Sell failed or was cancelled"
          fi
